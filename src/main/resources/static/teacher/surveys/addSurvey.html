<!DOCTYPE html>

<html lang="en">

    <head>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <!-- Meta, title, CSS, favicons, etc. -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Ajout d'un questionnaire</title>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

        <!-- Bootstrap -->
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <!-- Font Awesome -->
        <link href="/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
        <!-- bootstrap-progressbar -->
        <link href="/vendors/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
        <!-- bootstrap-daterangepicker -->
        <link href="/vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
        <!-- Custom Theme Style -->
        <link href="/custom.min.css" rel="stylesheet">

    </head>

    <body class="nav-md">

        <div class="container body">
            <div class="main_container">
                <div class="col-md-3 left_col">
                    <div class="left_col scroll-view">
                        <div class="navbar nav_title" style="border: 0;">
                            <a href="/teacher/home" class="site_title"><span>Brotherhood</span></a>
                        </div>

                        <div class="clearfix"></div>

                        <!-- menu profile quick info -->
                        <div class="profile clearfix">
                            <div class="profile_pic">
                                <img src="/images/logo.png" alt="..." class="img-circle profile_img">
                            </div>
                            <div class="profile_info">
                                <span>Welcome,</span>
                                <h2 class="firstnamelastname"></h2>
                            </div>
                        </div>
                        <!-- /menu profile quick info -->

                        <br />

                        <!-- sidebar menu -->
                        <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
                            <div class="menu_section">
                                <h3>General</h3>
                                <ul class="nav side-menu">
                                    <li><a><i class="fa fa-home"></i> Accueil <span class="fa fa-chevron-down"></span></a>
                                        <ul class="nav child_menu">
                                            <li><a href="/teacher/manageClassmate/view">Ajouter une note</a></li>
                                            <li><a href="/teacher/surveys/viewSurveys/view">Voir les questionnaires</a></li>
                                            <li><a href="/teacher/surveys/addSurvey/view">Ajouter un questionnaire</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <!-- /sidebar menu -->

                        <!-- /menu footer buttons -->
                        <div class="sidebar-footer hidden-small">
                            <a data-toggle="tooltip" style="width:100%" data-placement="top" title="Logout" href="/home">
                                <span class="glyphicon glyphicon-off"  aria-hidden="true"></span>
                            </a>
                        </div>
                        <!-- /menu footer buttons -->
                    </div>
                </div>

                <!-- top navigation -->
                <div class="top_nav">
                    <div class="nav_menu">
                        <nav>
                            <div class="nav toggle">
                                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
                            </div>

                            <ul class="nav navbar-nav navbar-right">
                                <li class="">
                                    <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                        <img src="/images/logo.png" alt=""><span class="firstnamelastname"></span>
                                        <span class=" fa fa-angle-down"></span>
                                    </a>
                                    <ul class="dropdown-menu dropdown-usermenu pull-right">
                                        <li><a href="/changePassword"> Profile</a></li>
                                        <li><a href="/home"><i class="fa fa-sign-out pull-right"></i> Log Out</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <!-- /top navigation -->

                <!-- page content -->
                <div class="right_col" role="main">
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="dashboard_graph">
                                <h1>Ajout d'un questionnaire</h1>

                                <p>

                                    <br/>

                                    <div id="survey" class="container body">

                                        <div id="surveyDetails" class="main_container" class="profile clearfix">

                                            <h2>Questionnaire :</h2> <span class='error'></span>

                                            <ul>
                                                <li>Image : <input type='file' name='surveyImage' class='surveyImage' class="profile_pic" accept='image/*'/></li>
                                                <li>Nom : <input type='text' name='surveyName' class='surveyName' required/><span class='error'></span></li>
                                                <li>Barème : <input type='number' name='surveyMark' class='surveyMark' min='0' step='0.1' readonly disabled required/><span class='error'></span></li>
                                                <li>Nombre d'essais possibles (0 = infini) : <input type='number' name='surveyChances' class='surveyChances' min='0' required/><span class='error'></span></li>
                                                <li>Date limite : <input type='date' name='surveyDeadLine' class='surveyDeadLine'/></li>
                                            </ul>

                                        </div>

                                        <br/>

                                        <div>

                                            <div id="questions">
                                            </div>

                                            <br/>
                                            <br/>

                                            <input type='button' name='addQuestion' class='addQuestion' value='Ajouter une question' onclick="addQuestion()"/>

                                        </div>

                                    </div>

                                    <br/>

                                    <p>
                                        <button onclick="saveAll()">Sauvegarder</button>
                                    </p>
                                </p>
                            </div>
                        </div>

                    </div>
                    <br />
                </div>
                <!-- /page content -->
            </div>
        </div>

        <script type = "text/javascript">

            $("input.surveyMark").val(parseFloat(0)) ;
            $("input.surveyChances").val(parseInt(0)) ;

            var today = new Date() ;
            var todayString = (today.getYear() + 1900) + "-" + ("0" + today.getMonth()).substr(-2, 2) + "-" + ("0" + today.getDay()).substr(-2, 2) ;

            $("input.surveyDeadLine").attr("min", todayString) ;
            $("input.surveyDeadLine").attr("value", todayString) ;


            var questionNumber = 1 ;
            var responseNumber = 1 ;

            var questionCounter = 1 ;
            var responseCounter = 1 ;


            function verifyNumberOfQuestions()
            {
                var isOk = true ;

                if($("div.question").get().length == 0)
                {
                    $("#surveyDetails").children("h2").next("span").text(" Vous devez avoir au moins une question") ;

                    isOk = false ;
                }

                else
                {
                    $("#surveyDetails").children("h2").next("span").text("") ;
                }

                return isOk ;
            }

            function verifyNumberOfResponsesFromQuestions()
            {
                var isOk = true ;

                var questions = $("div.question").get() ;

                for(var i = 0 ; i < questions.length ; i++)
                {
                    if($("div.question[id='" + questions[i].id + "']").children("div.responses").children("div.response").get().length == 0)
                    {
                        $("div.question[id='" + questions[i].id + "']").children("input").next("span").text(" Vous devez avoir au moins une réponse") ;

                        isOk = false ;
                    }

                    else
                    {
                        $("div.question[id='" + questions[i].id + "']").children("input").next("span").text("") ;
                    }
                }

                return isOk ;
            }

            function verifySurveyDetails()
            {
                var isOk = true ;

                if($("input.surveyName").val() == "")
                {
                    $("input.surveyName").next("span").text(" Vous devez entrer un nom") ;

                    isOk = false ;
                }

                else
                {
                    $("input.surveyName").next("span").text("") ;
                }

                if($("input.surveyMark").val() == "")
                {
                    $("input.surveyMark").next("span").text(" Vous devez avoir un barême") ;

                    isOk = false ;
                }

                else
                {
                    $("input.surveyMark").next("span").text("") ;
                }

                if($("input.surveyChances").val() == "")
                {
                    $("input.surveyChances").next("span").text(" Vous devez entrer le nombre d'essais") ;

                    isOk = false ;
                }

                else
                {
                    $("input.surveyChances").next("span").text("") ;
                }

                return isOk ;
            }

            function verifyQuestionsDetails()
            {
                var isOk = true ;

                var questionsDescription = $("input.questionDescription").get() ;

                for(var i = 0 ; i < questionsDescription.length ; i++)
                {
                    if(questionsDescription[i].value == "")
                    {
                        questionsDescription[i].nextElementSibling.textContent = " Vous devez entrer la description de la question" ;

                        isOk = false ;
                    }

                    else
                    {
                        questionsDescription[i].nextElementSibling.textContent = "" ;
                    }
                }

                var questionsPoints = $("input.questionPoints").get() ;

                for(var i = 0 ; i < questionsPoints.length ; i++)
                {
                    if(questionsPoints[i].value == "")
                    {
                        questionsPoints[i].nextElementSibling.textContent = " Vous devez entrer le nombre de points" ;

                        isOk = false ;
                    }

                    else
                    {
                        questionsPoints[i].nextElementSibling.textContent = "" ;
                    }
                }

                return isOk ;
            }

            function verifyResponsesDetails()
            {
                var isOk = true ;

                var responsesDescription = $("input.responseDescription").get() ;

                for(var i = 0 ; i < responsesDescription.length ; i++)
                {
                    if(responsesDescription[i].value == "")
                    {
                        responsesDescription[i].nextElementSibling.textContent = " Vous devez entrer la description de la réponse" ;

                        isOk = false ;
                    }

                    else
                    {
                        responsesDescription[i].nextElementSibling.textContent = "" ;
                    }
                }

                return isOk ;
            }

            function verifyAll()
            {
                var isOk = false ;

                if(verifyNumberOfQuestions() == true && verifyNumberOfResponsesFromQuestions() == true)
                {
                    if(verifySurveyDetails() == true && verifyQuestionsDetails() == true && verifyResponsesDetails() == true)
                    {
                        isOk = true ;
                    }
                }

                return isOk ;
            }


            function calculateMark()
            {
                var result = 0 ;

                var questionsPoints = $("input.questionPoints").get() ;

                for(var i = 0 ; i < questionsPoints.length ; i++)
                {
                    if(questionsPoints[i].value != "")
                    {
                        result += parseFloat(questionsPoints[i].value) ;
                    }
                }

                $("input.surveyMark").val(parseFloat(result)) ;
            }


            function addQuestion()
            {
                $("#questions").append(function()
                {
                    questionNumber = $("div.question").get().length + 1 ;

                    var dom = "<div class='question' id='q" + questionCounter + "'>" ;

                        dom += "<h3>Question " + questionNumber + " : </h3>" ;

                        dom += "<input type='button' name='removeQuestion' class='removeQuestion' value='Supprimer la question' onclick='removeQuestion(" + questionCounter + ")'/><span class='error'></span>" ;

                        dom += "<ul>" ;

                            dom += "<li>Image : <input type='file' name='questionImage' class='questionImage' accept='image/*'/></li>" ;
                            dom += "<li>Description : <input type='text' name='questionDescription' class='questionDescription' required/><span class='error'></span></li>" ;
                            dom += "<li>Points : <input type='number' name='questionPoints' class='questionPoints' min='0' value='" + parseFloat(0) + "' step='0.1' onchange='calculateMark()' required/><span class='error'></span></li>" ;
                            dom += "<li>Tout ou rien : <input type='checkbox' name='questionAllOrNot' class='questionAllOrNot'/></li>" ;

                        dom += "</ul>" ;

                        dom += "<div class='responses'></div>" ;

                        dom += "<input type='button' name='addResponse' class='addResponse' value='Ajouter une réponse' onclick='addResponse(" + questionCounter + ")'/>" ;

                    dom += "<br/><br/></div>" ;

                    return dom ;
                }) ;

                questionCounter++ ;
            }

            function removeQuestion(questionId)
            {
                $("div[id='q" + questionId + "']").remove() ;

                var questions = $("div.question").get() ;

                for(var i = 0 ; i < questions.length ; i++)
                {
                    $("div.question[id='" + questions[i].id + "']").children("h3").text("Question " + (i + 1) + " : ") ;
                }
            }

            function addResponse(questionId)
            {
                if($("div[id='q" + questionId + "']").children("div.responses").children("div.response").length > 0)
                {
                    responseCounter = parseInt($("div[id='q" + questionId + "']").children("div.responses").children("div.response:last-child").children("h4").attr("class")) + 1 ;
                }

                else
                {
                    responseCounter = 1 ;
                }

                responseNumber = $("div[id='q" + questionId + "']").children("div.responses").children("div.response").length + 1 ;

                $("div[id='q" + questionId + "']").children("div.responses").append(function()
                {
                    var dom = "<div class='response' id='q" + questionId + "r" + responseCounter + "'>" ;

                        dom += "<h4 class='" + responseCounter + "'>Réponse " + responseNumber + " : </h4>" ;

                        dom += "<input type='button' name='removeResponse' class='removeResponse' value='Supprimer la réponse' onclick='removeResponse(" + questionId + ", " + responseCounter + ")'/>" ;

                        dom += "<ul>" ;

                            dom += "<li>Image : <input type='file' name='responseImage' class='responseImage' accept='image/*'/></li>" ;
                            dom += "<li>Description : <input type='text' name='responseDescription' class='responseDescription' required/><span class='error'></span></li>" ;

                            dom += "<li>Réponse correcte : <input type='checkbox' name='correctResponse' class='correctResponse'/></li>" ;

                        dom += "</ul>" ;

                    dom += "</div>" ;

                    return dom ;
                }) ;

                responseCounter++ ;
            }

            function removeResponse(questionId, responseId)
            {
                $("div[id='q" + questionId + "r" + responseId + "']").remove() ;

                var responses = $("div.question[id='q" + questionId + "']").children("div.responses").children("div.response").get() ;

                for(var i = 0 ; i < responses.length ; i++)
                {
                    $("div.response[id='" + responses[i].id + "']").children("h4").text("Réponse " + (i + 1) + " : ") ;
                }
            }

            var responses = {} ;
            var correctResponses = {} ;
            var questions = [] ;

            function saveResponses()
            {
                var domQuestions = $("div.question") ;

                for(var i = 0 ; i < domQuestions.length ; i++)
                {
                    var questionReference = domQuestions[i].id ;
                    var domResponses = $("div.question[id='" + questionReference + "']").children("div.responses").children("div.response") ;

                    responses[questionReference] = new Array() ;
                    correctResponses[questionReference] = new Array() ;

                    for(var j = 0 ; j < domResponses.get().length ; j++)
                    {
                        $.post("/responses/addResponse",
                        {
                            description: domResponses.find("input.responseDescription")[j].value,
                            imageId: domResponses.find("input.responseImage")[j].value
                        }).done(function(data)
                        {
                            responses[questionReference].push(data["id"]) ;

                            for(var k = 0 ; k < domResponses.get().length ; k++)
                            {
                                if (domResponses.find("input.correctResponse")[k].checked)
                                {
                                    correctResponses[questionReference].push(data["id"]) ;
                                }
                            }
                        }).done() ;
                    }
                }
            }

            function saveQuestions()
            {
                var domQuestions = $("div.question") ;

                for(var i = 0 ; i < domQuestions.length ; i++)
                {
                    var questionReference = domQuestions[i].id ;

                    $.post("/questions/addQuestion",
                    {
                        description: domQuestions.find("input.questionDescription")[i].value,
                        points: parseFloat(domQuestions.find("input.questionPoints")[i].value),
                        allOrNot: domQuestions.find("input.questionAllOrNot")[i].checked,
                        imageId: domQuestions.find("input.questionImage")[i].value
                    }).done(function(data)
                    {
                        for(var k = 0 ; k < responses[questionReference].length ; k++)
                        {
                            $.post("/questions/addResponseForAQuestion",
                            {
                                questionId: data["id"],
                                responseId: responses[questionReference][k]
                            }).done() ;
                        }

                        for(var l = 0 ; l < correctResponses[questionReference].length ; l++)
                        {
                            $.post("/questions/addCorrectResponseForAQuestion",
                            {
                                questionId: data["id"],
                                correctResponseId: correctResponses[questionReference][l]
                            }).done() ;
                        }

                        questions.push(data["id"]) ;
                    }).done() ;
                }
            }

            function saveSurvey()
            {
                var domSurvey = $("#surveyDetails") ;

                $.post("/surveys/addSurvey",
                {
                    name: domSurvey.find("input.surveyName")[0].value,
                    mark: parseFloat(domSurvey.find("input.surveyMark")[0].value),
                    chances: parseInt(domSurvey.find("input.surveyChances")[0].value),
                    deadLine: domSurvey.find("input.surveyDeadLine")[0].value,
                    imageId: domSurvey.find("input.surveyImage")[0].value
                }).done(function(data)
                {
                    for(var i = 0 ; i < questions.length ; i++)
                    {
                        $.post("/surveys/addQuestionForASurvey",
                        {
                            surveyId: data["id"],
                            questionId: questions[i]
                        }).done() ;
                    }
                }) ;
            }

            function saveAll()
            {
                if(verifyAll())
                {
                    saveResponses() ;

                    saveQuestions() ;

                    saveSurvey() ;
                }

                //window.location.replace("/teacher/surveys/viewSurveys/view") ;
            }

        </script>

    </body>

</html>