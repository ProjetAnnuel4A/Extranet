<!DOCTYPE html>

<html lang="en">

    <head>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <!-- Meta, title, CSS, favicons, etc. -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Modifier le questionnaire</title>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

        <!-- Bootstrap -->
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <!-- Font Awesome -->
        <link href="/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
        <!-- bootstrap-progressbar -->
        <link href="/vendors/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
        <!-- bootstrap-daterangepicker -->
        <link href="/vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
        <!-- Custom Theme Style -->
        <link href="/custom.min.css" rel="stylesheet">

    </head>

    <body class="nav-md">

        <div class="container body">
            <div class="main_container">
                <div class="col-md-3 left_col">
                    <div class="left_col scroll-view">
                        <div class="navbar nav_title" style="border: 0;">
                            <a href="/teacher/home" class="site_title"><span>Brotherhood</span></a>
                        </div>

                        <div class="clearfix"></div>

                        <!-- menu profile quick info -->
                        <div class="profile clearfix">
                            <div class="profile_pic">
                                <img src="/images/logo.png" alt="..." class="img-circle profile_img">
                            </div>
                            <div class="profile_info">
                                <span>Welcome,</span>
                                <h2 class="firstnamelastname"></h2>
                            </div>
                        </div>
                        <!-- /menu profile quick info -->

                        <br />

                        <!-- sidebar menu -->
                        <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
                            <div class="menu_section">
                                <h3>General</h3>
                                <ul class="nav side-menu">
                                    <li><a><i class="fa fa-home"></i> Accueil <span class="fa fa-chevron-down"></span></a>
                                        <ul class="nav child_menu">
                                            <li><a href="/teacher/manageClassmate/view">Ajouter une note</a></li>
                                            <li><a href="/teacher/surveys/viewSurveys/view">Voir les questionnaires</a></li>
                                            <li><a href="/teacher/surveys/addSurvey/view">Ajouter un questionnaire</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <!-- /sidebar menu -->

                        <!-- /menu footer buttons -->
                        <div class="sidebar-footer hidden-small">
                            <a data-toggle="tooltip" style="width:100%" data-placement="top" title="Logout" href="/home">
                                <span class="glyphicon glyphicon-off"  aria-hidden="true"></span>
                            </a>
                        </div>
                        <!-- /menu footer buttons -->
                    </div>
                </div>

                <!-- top navigation -->
                <div class="top_nav">
                    <div class="nav_menu">
                        <nav>
                            <div class="nav toggle">
                                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
                            </div>

                            <ul class="nav navbar-nav navbar-right">
                                <li class="">
                                    <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                        <img src="/images/logo.png" alt=""><span class="firstnamelastname"></span>
                                        <span class=" fa fa-angle-down"></span>
                                    </a>
                                    <ul class="dropdown-menu dropdown-usermenu pull-right">
                                        <li><a href="/changePassword"> Profile</a></li>
                                        <li><a href="/home"><i class="fa fa-sign-out pull-right"></i> Log Out</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <!-- /top navigation -->

                <!-- page content -->
                <div class="right_col" role="main">
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="dashboard_graph">
                                <h1>Modifier le questionnaire</h1>

                                <p>

                                    <br/>

                                    <div id="survey">

                                        <div id="surveyDetails" style="margin-left:50px">

                                            <h2>Questionnaire :</h2> <span class='error'></span>

                                            <ul class="container">
                                                <li class="row" hidden>Image : <input type='file' name='surveyImage' class='surveyImage' class="profile_pic" accept='image/*'/></li>
                                                <li class="row">Nom : <input type='text' name='surveyName' class='surveyName' required/><span class='error'></span></li>
                                                <li class="row">Barème : <input type='number' name='surveyMark' class='surveyMark' min='0' step='0.1' readonly disabled required/><span class='error'></span></li>
                                                <li class="row">Nombre d'essais possibles (0 = infini) : <input type='number' name='surveyChances' class='surveyChances' min='0' required/><span class='error'></span></li>
                                                <li class="row">Date de début : <input type='date' name='surveyBeginLine' class='surveyBeginLine' onchange='updateDeadLine()'/><span class='error'></span></li>
                                                <li class="row">Date de fin : <input type='date' name='surveyDeadLine' class='surveyDeadLine'/><span class='error'></span></li>
                                            </ul>

                                        </div>

                                        <br/>

                                        <div>

                                            <div id="questions" class="container" style="margin-left:100px">
                                            </div>

                                            <br/>
                                            <br/>

                                            <input type="button" name="addQuestion" class="addQuestion" value="Ajouter une question" onclick="addQuestion()" style="margin-left:100px"/>

                                        </div>

                                    </div>

                                    <br/>
                                    <br/>

                                    <p>
                                        <button onclick="saveAll()">Sauvegarder</button>
                                    </p>
                                </p>
                            </div>
                        </div>

                    </div>
                    <br />
                </div>
                <!-- /page content -->
            </div>
        </div>

        <script type = "text/javascript">

            var today = new Date() ;
            var tomorrow = new Date() ;
            tomorrow = new Date(tomorrow.setDate(tomorrow.getDate() + 1)) ;


            $("input.surveyMark").val(parseFloat(0)) ;
            $("input.surveyChances").val(parseInt(0)) ;


            function dateToDateFormFormat(date)
            {
                var dateFormatted = date.getFullYear() + "-" + ("0" + (date.getMonth() + 1)).substr(-2, 2) + "-" + ("0" + date.getDate()).substr(-2, 2) ;

                return dateFormatted ;
            }

            function updateDeadLine()
            {
                var beginDate = new Date() ;
                var deadDate = beginDate ;
                var beginDateForm = $("input.surveyBeginLine").val() ;
                var deadDateForm = $("input.surveyDeadLine").val() ;

                if(beginDateForm != "")
                {
                    beginDate = new Date(beginDateForm) ;

                    if(deadDateForm != "")
                    {
                        deadDate = new Date(deadDateForm) ;
                    }

                    else
                    {
                        deadDate = beginDate ;
                    }
                }

                if(beginDate >= deadDate)
                {
                    deadDate = new Date(beginDate.setDate(beginDate.getDate() + 1)) ;

                    $("input.surveyDeadLine").attr("value", dateToDateFormFormat(deadDate)) ;
                    $("input.surveyDeadLine").attr("min", dateToDateFormFormat(deadDate)) ;
                }

                else
                {
                    deadDate = new Date(beginDate.setDate(beginDate.getDate() + 1)) ;

                    if(deadDate > today)
                    {
                        $("input.surveyDeadLine").attr("min", dateToDateFormFormat(deadDate)) ;
                    }

                    else
                    {
                        $("input.surveyDeadLine").attr("min", dateToDateFormFormat(tomorrow)) ;
                    }
                }
            }

            $("input.surveyBeginLine").attr("value", dateToDateFormFormat(today)) ;
            $("input.surveyBeginLine").attr("min", dateToDateFormFormat(today)) ;

            $("input.surveyDeadLine").attr("min", dateToDateFormFormat(tomorrow)) ;

            updateDeadLine() ;


            function getCookie(name)
            {
                var value = "; " + document.cookie ;
                var parts = value.split("; " + name + "=") ;

                if (parts.length == 2) return parts.pop().split(";").shift() ;
            }

            var urlStudent = "/student/home" ;
            var urlAdmin = "/admin/home" ;
            var urlDefault = "/home" ;

            if(getCookie("brotherhood") == null)
                window.location.replace(urlDefault) ;

            $.post("/users/verifyToken",
                {
                    token: getCookie("brotherhood")
                }).done(function(data)
            {
                switch(data)
                {
                    case "STUDENT":
                        window.location.replace(urlStudent) ;
                        break ;
                    case "TEACHER":
                        break ;
                    case "ADMIN":
                        window.location.replace(urlAdmin) ;
                        break ;
                    default:
                        window.location.replace(urlDefault) ;
                        break ;
                }
            }) ;

            $.post("/users/getInformations",
                {
                    token : getCookie("brotherhood")
                }).done(function(data)
            {
                var content = "" ;

                $.each(data, function(key, val)
                {
                    if(key == "firstname" || key == "lastname")
                        content += val + " " ;
                }) ;

                $(".firstnamelastname").append(content) ;
            }) ;

            var getUrlParameter = function getUrlParameter(sParam)
            {
                var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                    sURLVariables = sPageURL.split('&'),
                    sParameterName,
                    i ;

                for(i = 0 ; i < sURLVariables.length ; i++)
                {
                    sParameterName = sURLVariables[i].split('=') ;

                    if(sParameterName[0] === sParam)
                    {
                        return sParameterName[1] === undefined ? true : sParameterName[1] ;
                    }
                }
            } ;


            var questionNumber = 1 ;
            var responseNumber = 1 ;

            var questionCounter = 1 ;
            var responseCounter = 1 ;


            function verifyNumberOfQuestions()
            {
                var isOk = true ;

                if($("div.question").get().length == 0)
                {
                    $("#surveyDetails").children("h2").next("span").text(" Vous devez avoir au moins une question") ;

                    isOk = false ;
                }

                else
                {
                    $("#surveyDetails").children("h2").next("span").text("") ;
                }

                return isOk ;
            }

            function verifyNumberOfResponsesFromQuestions()
            {
                var isOk = true ;

                var questions = $("div.question").get() ;

                for(var i = 0 ; i < questions.length ; i++)
                {
                    if($("div.question[id='" + questions[i].id + "']").children("div.responses").children("div.response").get().length == 0)
                    {
                        $("div.question[id='" + questions[i].id + "']").children("input").next("span").text(" Vous devez avoir au moins une réponse") ;

                        isOk = false ;
                    }

                    else
                    {
                        $("div.question[id='" + questions[i].id + "']").children("input").next("span").text("") ;
                    }
                }

                return isOk ;
            }

            function verifySurveyDetails()
            {
                var isOk = true ;

                if($("input.surveyName").val() == "")
                {
                    $("input.surveyName").next("span").text(" Vous devez entrer un nom") ;

                    isOk = false ;
                }

                else
                {
                    $("input.surveyName").next("span").text("") ;
                }

                if($("input.surveyMark").val() == "")
                {
                    $("input.surveyMark").next("span").text(" Vous devez avoir un barême") ;

                    isOk = false ;
                }

                else
                {
                    $("input.surveyMark").next("span").text("") ;
                }

                if($("input.surveyChances").val() == "")
                {
                    $("input.surveyChances").next("span").text(" Vous devez entrer le nombre d'essais") ;

                    isOk = false ;
                }

                else
                {
                    $("input.surveyChances").next("span").text("") ;
                }

                return isOk ;
            }

            function verifyQuestionsDetails()
            {
                var isOk = true ;

                var questionsDescription = $("input.questionDescription").get() ;

                for(var i = 0 ; i < questionsDescription.length ; i++)
                {
                    if(questionsDescription[i].value == "")
                    {
                        questionsDescription[i].nextElementSibling.textContent = " Vous devez entrer la description de la question" ;

                        isOk = false ;
                    }

                    else
                    {
                        questionsDescription[i].nextElementSibling.textContent = "" ;
                    }
                }

                var questionsPoints = $("input.questionPoints").get() ;

                for(var i = 0 ; i < questionsPoints.length ; i++)
                {
                    if(questionsPoints[i].value == "")
                    {
                        questionsPoints[i].nextElementSibling.textContent = " Vous devez entrer le nombre de points" ;

                        isOk = false ;
                    }

                    else
                    {
                        questionsPoints[i].nextElementSibling.textContent = "" ;
                    }
                }

                return isOk ;
            }

            function verifyResponsesDetails()
            {
                var isOk = true ;

                var responsesDescription = $("input.responseDescription").get() ;

                for(var i = 0 ; i < responsesDescription.length ; i++)
                {
                    if(responsesDescription[i].value == "")
                    {
                        responsesDescription[i].nextElementSibling.textContent = " Vous devez entrer la description de la réponse" ;

                        isOk = false ;
                    }

                    else
                    {
                        responsesDescription[i].nextElementSibling.textContent = "" ;
                    }
                }

                return isOk ;
            }

            function verifyAll()
            {
                var isOk = false ;

                if(verifyNumberOfQuestions() == true && verifyNumberOfResponsesFromQuestions() == true)
                {
                    if(verifySurveyDetails() == true && verifyQuestionsDetails() == true && verifyResponsesDetails() == true)
                    {
                        isOk = true ;
                    }
                }

                return isOk ;
            }


            function calculateMark()
            {
                var result = 0 ;

                var questionsPoints = $("input.questionPoints").get() ;

                for(var i = 0 ; i < questionsPoints.length ; i++)
                {
                    if(questionsPoints[i].value != "")
                    {
                        result += parseFloat(questionsPoints[i].value) ;
                    }
                }

                $("input.surveyMark").val(parseFloat(result)) ;
            }


            function addQuestion()
            {
                $("#questions").append(function()
                {
                    questionNumber = $("div.question").get().length + 1 ;

                    var dom = "<div class='question' class='container' id='q" + questionCounter + "'>" ;

                    dom += "<h3>Question " + questionNumber + " : </h3>" ;

                    dom += "<input type='button' name='removeQuestion' class='removeQuestion' value='Supprimer la question' onclick='removeQuestion(" + questionCounter + ")'/><span class='error'></span>" ;

                    dom += "<ul class='container'>" ;

                    dom += "<li class='row' hidden>Image : <input type='file' name='questionImage' class='questionImage' accept='image/*'/></li>" ;
                    dom += "<li class='row'>Description : <input type='text' name='questionDescription' class='questionDescription' required/><span class='error'></span></li>" ;
                    dom += "<li class='row'>Points : <input type='number' name='questionPoints' class='questionPoints' min='0' value='" + parseFloat(0) + "' step='0.1' onchange='calculateMark()' required/><span class='error'></span></li>" ;
                    dom += "<li class='row'>Tout correct ou rien : <input type='checkbox' name='questionAllOrNone' class='questionAllOrNone'/></li>" ;

                    dom += "</ul>" ;

                    dom += "<br/>" ;

                    dom += "<div class='responses' style='margin-left:150px'></div>" ;

                    dom += "<input type='button' name='addResponse' class='addResponse' value='Ajouter une réponse' onclick='addResponse(" + questionCounter + ")' style='margin-left:150px'/>" ;

                    dom += "<br/><br/></div>" +
                        "" ;

                    return dom ;
                }) ;

                questionCounter++ ;
            }

            function removeQuestion(questionId)
            {
                $("div[id='q" + questionId + "']").remove() ;

                var questions = $("div.question").get() ;

                for(var i = 0 ; i < questions.length ; i++)
                {
                    $("div.question[id='" + questions[i].id + "']").children("h3").text("Question " + (i + 1) + " : ") ;
                }
            }

            function addResponse(questionId)
            {
                if($("div[id='q" + questionId + "']").children("div.responses").children("div.response").length > 0)
                {
                    responseCounter = parseInt($("div[id='q" + questionId + "']").children("div.responses").children("div.response:last-child").children("h4").attr("class")) + 1 ;
                }

                else
                {
                    responseCounter = 1 ;
                }

                responseNumber = $("div[id='q" + questionId + "']").children("div.responses").children("div.response").length + 1 ;

                $("div[id='q" + questionId + "']").children("div.responses").append(function()
                {
                    var dom = "<div class='response' class='container' id='q" + questionId + "r" + responseCounter + "'>" ;

                    dom += "<h4 class='" + responseCounter + "'>Réponse " + responseNumber + " : </h4>" ;

                    dom += "<input type='button' name='removeResponse' class='removeResponse' value='Supprimer la réponse' onclick='removeResponse(" + questionId + ", " + responseCounter + ")'/>" ;

                    dom += "<ul class='container'>" ;

                    dom += "<li class='row' hidden>Image : <input type='file' name='responseImage' class='responseImage' accept='image/*'/></li>" ;
                    dom += "<li class='row'>Description : <input type='text' name='responseDescription' class='responseDescription' required/><span class='error'></span></li>" ;

                    dom += "<li class='row'>Réponse correcte : <input type='checkbox' name='correctResponse' class='correctResponse'/></li>" ;

                    dom += "</ul>" ;

                    dom += "<br/></div>" ;

                    return dom ;
                }) ;

                responseCounter++ ;
            }

            function removeResponse(questionId, responseId)
            {
                $("div[id='q" + questionId + "r" + responseId + "']").remove() ;

                var responses = $("div.question[id='q" + questionId + "']").children("div.responses").children("div.response").get() ;

                for(var i = 0 ; i < responses.length ; i++)
                {
                    $("div.response[id='" + responses[i].id + "']").children("h4").text("Réponse " + (i + 1) + " : ") ;
                }
            }


            var surveyId = getUrlParameter('surveyId') ;

            var surveyDatas = {} ;
            var surveyQuestions = {} ;
            var questionsResponses = {} ;

            $.getJSON("/surveys/getSurvey?surveyId=" + surveyId, function(data)
            {
                surveyDatas = data ;
                surveyQuestions = data["questions"] ;

                $.each(surveyQuestions, function(key, val)
                {
                    questionsResponses[key] = val["responses"] ;
                }) ;
            }).done(function()
            {
                var domSurvey = $("#surveyDetails") ;
                domSurvey.find("input.surveyName")[0].value = surveyDatas["name"] ;
                domSurvey.find("input.surveyMark")[0].value = parseFloat(surveyDatas["mark"]) ;
                domSurvey.find("input.surveyChances")[0].value = parseInt(surveyDatas["chances"]) ;
                domSurvey.find("input.surveyBeginLine")[0].value = surveyDatas["beginLine"] ;
                domSurvey.find("input.surveyDeadLine")[0].value = surveyDatas["deadLine"] ;
                domSurvey.find("input.surveyImage")[0].value = surveyDatas["imageId"] ;

                $.each(surveyQuestions, function(qkey, qval)
                {
                    addQuestion() ;

                    var domQuestions = $("div.question") ;
                    domQuestions.find("input.questionDescription")[qkey].value = qval["description"] ;
                    domQuestions.find("input.questionPoints")[qkey].value = parseFloat(qval["points"]) ;
                    domQuestions.find("input.questionAllOrNone")[qkey].checked = qval["allOrNone"] ;
                    domQuestions.find("input.questionImage")[qkey].value = qval["imageId"] ;

                    $.each(questionsResponses[qkey], function(rkey, rval)
                    {
                        addResponse((qkey + 1)) ;

                        var domResponses = $("div.question[id='q" + (qkey + 1) + "']").children("div.responses").children("div.response") ;
                        domResponses.find("input.responseDescription")[rkey].value = rval["description"] ;
                        domResponses.find("input.responseImage")[rkey].value = rval["imageId"] ;
                    }) ;
                }) ;
            }) ;


            var responses = {} ;
            var correctResponses = {} ;
            var questions = [] ;

            function saveResponses(indexQuestion, indexResponse)
            {
                var domQuestions = $("div.question") ;

                // Pour la première itération récursive
                if((indexQuestion == 0) && (indexResponse == 0))
                {
                    responses[indexQuestion] = new Array() ;
                    correctResponses[indexQuestion] = new Array() ;
                }

                var questionReference = "q" + (indexQuestion + 1) ;
                var domResponses = $("div.question[id='" + questionReference + "']").children("div.responses").children("div.response") ;

                if(indexResponse >= domResponses.length)
                {
                    indexQuestion = indexQuestion + 1 ;
                    indexResponse = 0 ;

                    if(indexQuestion < domQuestions.length)
                    {
                        responses[indexQuestion] = new Array() ;
                        correctResponses[indexQuestion] = new Array() ;

                        questionReference = "q" + (indexQuestion + 1) ;

                        domResponses = $("div.question[id='" + questionReference + "']").children("div.responses").children("div.response") ;
                    }

                    else
                    {
                        return saveQuestions(0) ;
                    }
                }

                $.post("/responses/addResponse",
                {
                    description: domResponses.find("input.responseDescription")[indexResponse].value,
                    imageId: domResponses.find("input.responseImage")[indexResponse].value
                }).done(function(data)
                {
                    responses[indexQuestion].push(data["id"]) ;

                    if(domResponses.find("input.correctResponse")[indexResponse].checked)
                    {
                        correctResponses[indexQuestion].push(data["id"]) ;
                    }
                }).done(function()
                {
                    indexResponse = indexResponse + 1 ;
                    saveResponses(indexQuestion, indexResponse) ;
                }) ;
            }

            function saveCorrectResponsesForAQuestion(questionId, indexQuestion, indexCorrectResponse)
            {
                if(indexCorrectResponse >= correctResponses[indexQuestion].length)
                {
                    questions.push(questionId) ;

                    indexQuestion = indexQuestion + 1 ;

                    return saveQuestions(indexQuestion) ;
                }

                $.post("/questions/addCorrectResponseForAQuestion",
                {
                    questionId: questionId,
                    correctResponseId: correctResponses[indexQuestion][indexCorrectResponse]
                }).done(function()
                {
                    indexCorrectResponse = indexCorrectResponse + 1 ;

                    saveCorrectResponsesForAQuestion(questionId, indexQuestion, indexCorrectResponse) ;
                }) ;
            }

            function saveResponsesForAQuestion(questionId, indexQuestion, indexResponse)
            {
                if(indexResponse >= responses[indexQuestion].length)
                {
                    return saveCorrectResponsesForAQuestion(questionId, indexQuestion, 0) ;
                }

                $.post("/questions/addResponseForAQuestion",
                {
                    questionId: questionId,
                    responseId: responses[indexQuestion][indexResponse]
                }).done(function()
                {
                    indexResponse = indexResponse + 1 ;

                    saveResponsesForAQuestion(questionId, indexQuestion, indexResponse) ;
                }) ;
            }

            function saveQuestions(indexQuestion)
            {
                var domQuestions = $("div.question") ;

                if(indexQuestion >= domQuestions.length)
                {
                    return saveSurvey() ;
                }

                var questionReference = "q" + (indexQuestion + 1) ;
                $.post("/questions/addQuestion",
                {
                    description: domQuestions.find("input.questionDescription")[indexQuestion].value,
                    points: parseFloat(domQuestions.find("input.questionPoints")[indexQuestion].value),
                    allOrNone: domQuestions.find("input.questionAllOrNone")[indexQuestion].checked,
                    imageId: domQuestions.find("input.questionImage")[indexQuestion].value
                }).done(function(data)
                {
                    saveResponsesForAQuestion(data["id"], indexQuestion, 0) ;
                }) ;
            }

            function saveQuestionsForASurvey(surveyId, indexQuestion)
            {
                if(indexQuestion >= questions.length)
                {
                    return window.location.replace("/teacher/surveys/viewSurveys/view") ;
                }

                $.post("/surveys/addQuestionForASurvey",
                {
                    surveyId: surveyId,
                    questionId: questions[indexQuestion]
                }).done(function()
                {
                    indexQuestion = indexQuestion + 1 ;

                    saveQuestionsForASurvey(surveyId, indexQuestion) ;
                }) ;
            }

            function saveSurvey()
            {
                var domSurvey = $("#surveyDetails") ;

                $.post("/surveys/addSurvey",
                {
                    name: domSurvey.find("input.surveyName")[0].value,
                    mark: parseFloat(domSurvey.find("input.surveyMark")[0].value),
                    chances: parseInt(domSurvey.find("input.surveyChances")[0].value),
                    beginLine: domSurvey.find("input.surveyBeginLine")[0].value,
                    deadLine: domSurvey.find("input.surveyDeadLine")[0].value,
                    imageId: domSurvey.find("input.surveyImage")[0].value
                }).done(function(data)
                {
                    return saveQuestionsForASurvey(data["id"], 0) ;
                }) ;
            }

            function saveAll()
            {
                if(verifyAll())
                {
                    $.getJSON("/surveys/getSurveyByName",
                    {
                        surveyName: $("#surveyDetails").find("input.surveyName")[0].value
                    }).done(function(data)
                    {
                        if((data["present"] == false) || ($("#surveyDetails").find("input.surveyName")[0].value == surveyDatas["name"]))
                        {
                            $("input.surveyName").next("span").text("") ;

                            $.get("/usersQuizz/getAllUsersQuizzBySurveyId", {surveyId: surveyId}).done(function(data)
                            {
                                $.each(data, function(key, val)
                                {
                                    $.post("/usersQuizz/removeUserQuizz", {userQuizzId: val["id"]}).done(function(){}) ;
                                }) ;
                            }).done(function()
                            {
                                $.post("/surveys/removeSurvey", {surveyId: surveyId}).done(function()
                                {
                                    return saveResponses(0, 0) ;
                                }) ;
                            }) ;
                        }

                        else
                        {
                            $("input.surveyName").next("span").text(" Le nom de ce questionnaire existe déjà") ;

                            alert("Le nom de ce questionnaire existe déjà") ;
                        }
                    }) ;
                }
            }

        </script>
        <!-- jQuery -->

        <!-- Custom Theme Scripts -->
        <script src="/custom.min.js"></script>

    </body>

</html>