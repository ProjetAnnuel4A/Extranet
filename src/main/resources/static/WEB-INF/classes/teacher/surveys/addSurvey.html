<!DOCTYPE html>

<html lang="en">

    <head>

        <meta charset="UTF-8">
        <title>Brotherhood - Ajout d'un questionnaire</title>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

        <!-- Bootstrap -->
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <!-- Font Awesome -->
        <link href="/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
        <!-- bootstrap-progressbar -->
        <link href="/vendors/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
        <!-- bootstrap-daterangepicker -->
        <link href="/vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
        <!-- Custom Theme Style -->
        <link href="/custom.min.css" rel="stylesheet">

    </head>

    <body class="nav-md">

        <div class="navbar nav_title" style="border: 0;">
            <a href="/student/home" class="site_title"><span>Retourner au menu principal</span></a>
        </div>
        <h1 class="fa fa-home">Ajout d'un questionnaire</h1>

        <br/>

        <div id="survey" class="container body">

            <div id="surveyDetails" class="main_container" class="profile clearfix">

                <h2>Questionnaire :</h2> <span class='error'></span>

                <ul>
                    <li>Image : <input type='file' name='surveyImage' class='surveyImage' class="profile_pic" accept='image/*'/></li>
                    <li>Nom : <input type='text' name='surveyName' class='surveyName' required/><span class='error'></span></li>
                    <li>Barème : <input type='number' name='surveyMark' class='surveyMark' min='0' step='0.1' readonly disabled required/><span class='error'></span></li>
                    <li>Nombre d'essais possibles (0 = infini) : <input type='number' name='surveyChances' class='surveyChances' min='0' required/><span class='error'></span></li>
                    <li>Date limite : <input type='date' name='surveyDeadLine' class='surveyDeadLine'/></li>
                </ul>

            </div>

            <br/>

            <div>

                <div id="questions">
                </div>

                <br/>
                <br/>

                <input type='button' name='addQuestion' class='addQuestion' value='Ajouter une question' onclick="addQuestion()"/>

            </div>

        </div>

        <br/>

        <p>
            <button onclick="saveSurvey()">Sauvegarder</button>
        </p>

        <script type = "text/javascript">

            $("input.surveyMark").val(parseFloat(0)) ;
            $("input.surveyChances").val(parseInt(0)) ;

            var today = new Date() ;
            var todayString = (today.getYear() + 1900) + "-" + ("0" + today.getMonth()).substr(-2, 2) + "-" + ("0" + today.getDay()).substr(-2, 2) ;

            $("input.surveyDeadLine").attr("min", todayString) ;
            $("input.surveyDeadLine").attr("value", todayString) ;


            var questionNumber = 1 ;
            var responseNumber = 1 ;

            var questionCounter = 1 ;
            var responseCounter = 1 ;


            function verifyNumberOfQuestions()
            {
                var isOk = true ;

                if($("div.question").get().length == 0)
                {
                    $("#surveyDetails").children("h2").next("span").text(" Vous devez avoir au moins une question") ;

                    isOk = false ;
                }

                else
                {
                    $("#surveyDetails").children("h2").next("span").text("") ;
                }

                return isOk ;
            }

            function verifyNumberOfResponsesFromQuestions()
            {
                var isOk = true ;

                var questions = $("div.question").get() ;

                for(var i = 0 ; i < questions.length ; i++)
                {
                    if($("div.question[id='" + questions[i].id + "']").children("div.responses").children("div.response").get().length == 0)
                    {
                        $("div.question[id='" + questions[i].id + "']").children("input").next("span").text(" Vous devez avoir au moins une réponse") ;

                        isOk = false ;
                    }

                    else
                    {
                        $("div.question[id='" + questions[i].id + "']").children("input").next("span").text("") ;
                    }
                }

                return isOk ;
            }

            function verifySurveyDetails()
            {
                var isOk = true ;

                if($("input.surveyName").val() == "")
                {
                    $("input.surveyName").next("span").text(" Vous devez entrer un nom") ;

                    isOk = false ;
                }

                else
                {
                    $("input.surveyName").next("span").text("") ;
                }

                if($("input.surveyMark").val() == "")
                {
                    $("input.surveyMark").next("span").text(" Vous devez avoir un barême") ;

                    isOk = false ;
                }

                else
                {
                    $("input.surveyMark").next("span").text("") ;
                }

                if($("input.surveyChances").val() == "")
                {
                    $("input.surveyChances").next("span").text(" Vous devez entrer le nombre d'essais") ;

                    isOk = false ;
                }

                else
                {
                    $("input.surveyChances").next("span").text("") ;
                }

                return isOk ;
            }

            function verifyQuestionsDetails()
            {
                var isOk = true ;

                var questionsDescription = $("input.questionDescription").get() ;

                for(var i = 0 ; i < questionsDescription.length ; i++)
                {
                    if(questionsDescription[i].value == "")
                    {
                        questionsDescription[i].nextElementSibling.textContent = " Vous devez entrer la description de la question" ;

                        isOk = false ;
                    }

                    else
                    {
                        questionsDescription[i].nextElementSibling.textContent = "" ;
                    }
                }

                var questionsPoints = $("input.questionPoints").get() ;

                for(var i = 0 ; i < questionsPoints.length ; i++)
                {
                    if(questionsPoints[i].value == "")
                    {
                        questionsPoints[i].nextElementSibling.textContent = " Vous devez entrer le nombre de points" ;

                        isOk = false ;
                    }

                    else
                    {
                        questionsPoints[i].nextElementSibling.textContent = "" ;
                    }
                }

                return isOk ;
            }

            function verifyResponsesDetails()
            {
                var isOk = true ;

                var responsesDescription = $("input.responseDescription").get() ;

                for(var i = 0 ; i < responsesDescription.length ; i++)
                {
                    if(responsesDescription[i].value == "")
                    {
                        responsesDescription[i].nextElementSibling.textContent = " Vous devez entrer la description de la réponse" ;

                        isOk = false ;
                    }

                    else
                    {
                        responsesDescription[i].nextElementSibling.textContent = "" ;
                    }
                }

                return isOk ;
            }

            function verifyAll()
            {
                var isOk = false ;

                if(verifyNumberOfQuestions == true && verifyNumberOfResponsesFromQuestions == true)
                {
                    if(verifySurveyDetails == true && verifyQuestionsDetails == true && verifyResponsesDetails == true)
                    {
                        isOk = true ;
                    }
                }

                return isOk ;
            }


            function calculateMark()
            {
                var result = 0 ;

                var questionsPoints = $("input.questionPoints").get() ;

                for(var i = 0 ; i < questionsPoints.length ; i++)
                {
                    if(questionsPoints[i].value != "")
                    {
                        result += parseInt(questionsPoints[i].value) ;
                    }
                }

                $("input.surveyMark").val(parseInt(result)) ;
            }


            function addQuestion()
            {
                $("#questions").append(function()
                {
                    questionNumber = $("div.question").get().length + 1 ;

                    var dom = "<div class='question' id='q" + questionCounter + "'>" ;

                        dom += "<h3>Question " + questionNumber + " : </h3>" ;

                        dom += "<input type='button' name='removeQuestion' class='removeQuestion' value='Supprimer la question' onclick='removeQuestion(" + questionCounter + ")'/><span class='error'></span>" ;

                        dom += "<ul>" ;

                            dom += "<li>Image : <input type='file' name='questionImage' class='questionImage' accept='image/*'/></li>" ;
                            dom += "<li>Description : <input type='text' name='questionDescription' class='questionDescription' required/><span class='error'></span></li>" ;
                            dom += "<li>Points : <input type='number' name='questionPoints' class='questionPoints' min='0' value='" + parseFloat(0) + "' step='0.1' onchange='calculateMark()' required/><span class='error'></span></li>" ;
                            dom += "<li>Tout ou rien : <input type='checkbox' name='questionAllOrNot' class='questionAllOrNot'/></li>" ;

                        dom += "</ul>" ;

                        dom += "<div class='responses'></div>" ;

                        dom += "<input type='button' name='addResponse' class='addResponse' value='Ajouter une réponse' onclick='addResponse(" + questionCounter + ")'/>" ;

                    dom += "<br/><br/></div>" ;

                    return dom ;
                }) ;

                questionCounter++ ;
            }

            function removeQuestion(questionId)
            {
                $("div[id='q" + questionId + "']").remove() ;

                var questions = $("div.question").get() ;

                for(var i = 0 ; i < questions.length ; i++)
                {
                    $("div.question[id='" + questions[i].id + "']").children("h3").text("Question " + (i + 1) + " : ") ;
                }
            }

            function addResponse(questionId)
            {
                if($("div[id='q" + questionId + "']").children("div.responses").children("div.response").length > 0)
                {
                    responseCounter = parseInt($("div[id='q" + questionId + "']").children("div.responses").children("div.response:last-child").children("h4").attr("class")) + 1 ;
                }

                else
                {
                    responseCounter = 1 ;
                }

                responseNumber = $("div[id='q" + questionId + "']").children("div.responses").children("div.response").length + 1 ;

                $("div[id='q" + questionId + "']").children("div.responses").append(function()
                {
                    var dom = "<div class='response' id='q" + questionId + "r" + responseCounter + "'>" ;

                        dom += "<h4 class='" + responseCounter + "'>Réponse " + responseNumber + " : </h4>" ;

                        dom += "<input type='button' name='removeResponse' class='removeResponse' value='Supprimer la réponse' onclick='removeResponse(" + questionId + ", " + responseCounter + ")'/>" ;

                        dom += "<ul>" ;

                            dom += "<li>Image : <input type='file' name='responseImage' class='responseImage' accept='image/*'/></li>" ;
                            dom += "<li>Description : <input type='text' name='responseDescription' class='responseDescription' required/><span class='error'></span></li>" ;

                            dom += "<li>Réponse correcte : <input type='checkbox' name='correctResponse' class='correctResponse'/></li>" ;

                        dom += "</ul>" ;

                    dom += "</div>" ;

                    return dom ;
                }) ;

                responseCounter++ ;
            }

            function removeResponse(questionId, responseId)
            {
                $("div[id='q" + questionId + "r" + responseId + "']").remove() ;

                var responses = $("div.question[id='q" + questionId + "']").children("div.responses").children("div.response").get() ;

                for(var i = 0 ; i < responses.length ; i++)
                {
                    $("div.response[id='" + responses[i].id + "']").children("h4").text("Réponse " + (i + 1) + " : ") ;
                }
            }

            function saveSurvey()
            {
                if(verifyAll())
                {
                    var domSurvey = $("#surveyDetails") ;

                    var domQuestions = $("div.question") ;
                    var questions = [] ;

                    for(var i = 0 ; i < domQuestions.length ; i++)
                    {
                        var domResponses = $("div.question[id='" + domQuestions[i].id + "']").children("div.responses").children("div.response").get() ;

                        var responses = [] ;
                        var correctResponses = [] ;

                        for(var j = 0 ; j < domResponses.length ; j++)
                        {
                            $.post("/responses/addResponse",
                            {
                                description: domResponses[j].children[2].children[1].children[0].value,
                                    imageId: domResponses[j].children[2].children[0].children[0].value
                            }).done(function(data)
                            {
                                responses.add(data["id"]) ;

                                if(domResponses[j].children[2].children[2].children[0].checked)
                                {
                                    correctResponses.add(data["id"]) ;
                                }
                            }) ;
                        }

                        $.post("/questions/addQuestion",
                        {
                            description: domQuestions[i].children[2].children[1].children[0].value,
                            points: domQuestions[i].children[2].children[2].children[0].value,
                            allOrNot: domQuestions[i].children[2].children[3].children[0].checked,
                            imageId: domQuestions[i].children[2].children[0].children[0].value
                        }).done(function(data)
                        {
                            for(var i = 0 ; i < responses.length ; i++)
                            {
                                $.post("/questions/addResponseForAQuestion",
                                {
                                    questionId: data["id"],
                                    responseId: responses[i]
                                }) ;
                            }

                            for(var i = 0 ; i < correctResponses.length ; i++)
                            {
                                $.post("/questions/addCorrectResponseForAQuestion",
                                {
                                    questionId: data["id"],
                                    responseId: correctResponses[i]
                                }) ;
                            }

                            questions.add(data["id"]) ;
                        }) ;
                    }

                    $.post("/surveys/addSurvey",
                    {
                        nom: domSurvey.children[1].children[1].children[0].value,
                        mark: domSurvey.children[1].children[2].children[0].value,
                        chances: domSurvey.children[1].children[3].children[0].value,
                        deadLine: domSurvey.children[1].children[4].children[0].value,
                        imageId: domSurvey.children[1].children[0].children[0].value
                    }).done(function(data)
                    {
                        for(var i = 0 ; i < questions.length ; i++)
                        {
                            $.post("/surveys/addQuestionForASurvey",
                            {
                                surveyId: data["id"],
                                questionId: questions[i]
                            }) ;
                        }
                    }) ;
                }

                window.location.replace("/teacher/viewSurveys") ;
            }

        </script>

    </body>

</html>