<!DOCTYPE html>

<html lang="en">

    <head>

        <meta charset="UTF-8">
        <title>Brotherhood - Résultats</title>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

        <!-- Bootstrap -->
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <!-- Font Awesome -->
        <link href="/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
        <!-- bootstrap-progressbar -->
        <link href="/vendors/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet">
        <!-- bootstrap-daterangepicker -->
        <link href="/vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
        <!-- Custom Theme Style -->
        <link href="/custom.min.css" rel="stylesheet">

    </head>

    <body>

        <a href="/student/home">Retourner au menu principal</a>
        <h1>Résultats</h1>

        <table id="surveys">

            <tr>

                <th>Image</th>
                <th>Nom</th>
                <th>Barème</th>
                <th>Essais</th>
                <th>Date limite</th>
                <th>Note</th>

            </tr>

        </table>

        <script>

            var getUrlParameter = function getUrlParameter(sParam)
            {
                var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                    sURLVariables = sPageURL.split('&'),
                    sParameterName,
                    i ;

                for(i = 0 ; i < sURLVariables.length ; i++)
                {
                    sParameterName = sURLVariables[i].split('=') ;

                    if(sParameterName[0] === sParam)
                    {
                        return sParameterName[1] === undefined ? true : sParameterName[1] ;
                    }
                }
            } ;

            var userId = getUrlParameter('userId') || getUrlParameter('id') ;


            var table = $("#surveys") ;

            var surveysDone = {} ;
            var surveysScore = {} ; // A FAIRE
            var today = new Date() ;

            $.getJSON("./getAllUsersQuizzByUserId?userId=" + userId, function(data)
            {
                $.each(data, function(key, val)
                {
                    surveysDone[val["surveyId"]] = val["count"] ;

                    $.get("./calculateSurveyScoreWithUserQuizzIdAndSurveyId?userQuizzId=" + val["id"] + "&surveyId=" + val["surveyId"], function(data)
                    {
                        surveysScore[val["surveyId"]] = data ;
                    }) ;
                }) ;
            }) ;

            $.getJSON("./surveys", function(data)
            {
                $.each(data, function(key, val)
                {
                    if(surveysDone[val["id"]] != null)
                    {
                        var dom = "<tr>" ;

                        dom += "<td id='image' value=" + val["imageId"] + ">" + val["imageId"] + "</td>" ;
                        dom += "<td>" + val["name"] + "</td>" ;
                        dom += "<td>" + val["mark"] + "</td>" ;
                        dom += "<td>" + val["chances"] + "</td>" ;
                        dom += "<td>" + val["deadLine"] + "</td>" ;
                        dom += "<td>" + surveysScore[val["surveyId"]] + "</td>" ;

                        if(val["deadLine"] >= today.getTime() && (surveysDone[val["id"]] < val["chances"] || val["chances"] == 0))
                        {
                            dom += "<td><button onclick='answerSurvey(" + userId + ", " + val["id"] + ")'>Réessayer</button></td>" ;
                        }

                        table.append(dom + "</tr>") ;
                    }
                }) ;
            }) ;


            function answerSurvey(userId, surveyId)
            {
                window.location.replace("/student/answerSurvey?userId=" + userId + "surveyId=" + surveyId + "&done=true") ;
            }

        </script>

    </body>

</html>